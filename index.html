<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sound Queue Manager</title>
    <script src="https://unpkg.com/wavesurfer.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* General Styles */
        body {
            background-color: #121212;
            color: #ffffff;
            font-family: "Arial", sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            margin: 0;
        }

        /* Top Bar */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #1c1c1c;
            padding: 10px 20px;
            border-bottom: 2px solid #FFD700;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .tab {
            color: #FFD700;
            cursor: pointer;
            font-weight: bold;
            padding: 5px 15px;
            position: relative;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #1c1c1c;
            border: 1px solid #FFD700;
            padding: 10px;
            top: 100%;
            left: 0;
            z-index: 1;
            border-radius: 8px;
            min-width: 200px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .tab:hover .dropdown-content {
            display: block;
        }

        .dropdown-content button, .dropdown-content input {
            background-color: transparent;
            color: #FFD700;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            display: block;
            width: 100%;
            text-align: left;
            transition: background-color 0.3s;
            margin: 5px 0;
            border-radius: 4px;
        }

        .dropdown-content button:hover, .dropdown-content input:hover {
            background-color: #333;
        }

        .dropdown-content input[type="file"] {
            display: none;
        }

        .dropdown-content label {
            display: block;
            width: 100%;
            cursor: pointer;
        }

        /* Go Button */
        .go-button {
            background-color: #00FF00;
            color: #121212;
            border: 2px solid #00CC00;
            padding: 12px 24px;
            cursor: pointer;
            border-radius: 8px;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.2s;
            box-shadow: 0 4px 6px rgba(0, 255, 0, 0.2);
        }

        .go-button:hover {
            background-color: #00CC00;
            transform: scale(1.05);
        }

        /* Left Panel */
        .left-panel {
            width: 100%;
            background-color: #1c1c1c;
            padding: 15px;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            position: relative;
        }

        .queue-table {
            background-color: #292929;
            border: 1px solid #555;
            width: 100%;
            border-radius: 8px;
            color: #ffffff;
            margin-top: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .queue-table th, .queue-table td {
            padding: 8px;
            text-align: left;
        }

        .queue-item.active {
            background-color: #FFD700;
            color: #121212;
            font-weight: bold;
        }

        .queue-item.active .play-pause-button {
            color: #121212;
        }

        .queue-item.active .progress-bar-fill {
            background-color: #121212;
        }

        .queue-item.next-track .progress-bar-fill {
            background-color: rgba(255, 215, 0, 0.5);
        }

        /* Progress Bar */
        .progress-container {
            display: flex;
            align-items: center;
            gap: 5px;
            width: 100%;
        }

        .progress-bar {
            flex-grow: 1;
            height: 5px;
            background-color: #555;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 5px;
            position: relative;
        }

        .progress-bar-fill {
            height: 100%;
            background-color: #4CAF50;
            width: 0%;
            transition: width 0.1s linear;
        }

        .time-left {
            font-size: 0.8em;
            color: #aaa;
            min-width: 50px;
            text-align: right;
        }

        /* Play/Pause Button */
        .play-pause-button {
            background-color: transparent;
            border: none;
            color: #FFD700;
            cursor: pointer;
            font-size: 1.2em;
            transition: color 0.3s;
            width: 100%;
            text-align: left;
        }

        .play-pause-button:hover {
            color: #ffffff;
        }

        /* Notes Input */
        .notes-input {
            background-color: #333;
            border: 1px solid #555;
            color: #ffffff;
            padding: 5px;
            border-radius: 4px;
            width: 100%;
            transition: border-color 0.3s;
        }

        .notes-input:focus {
            border-color: #FFD700;
            outline: none;
        }

        /* Track number editing */
        .track-number {
            cursor: pointer;
        }

        .track-number-input {
            background-color: #333;
            border: 1px solid #FFD700;
            color: #ffffff;
            width: 30px;
            text-align: center;
            border-radius: 4px;
        }

        /* Action Buttons */
        .action-button {
            background-color: transparent;
            border: none;
            color: #FFD700;
            cursor: pointer;
            font-size: 1em;
            margin: 0 5px;
            transition: color 0.3s;
        }

        .action-button:hover {
            color: #ffffff;
        }

        /* Waveform container */
        #waveform {
            margin-top: 20px;
            border-radius: 8px;
            background: #292929;
            padding: 10px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .go-button {
                position: static;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="tab" role="button" aria-label="Files Menu">
            Files
            <div class="dropdown-content">
                <label for="fileInput" style="cursor: pointer;">Import Music</label>
                <input type="file" id="fileInput" multiple accept="audio/*" aria-label="Upload audio files">
                <button onclick="exportProject()">Export Project</button>
                <label for="importProjectInput" style="cursor: pointer;">Load Project</label>
                <input type="file" id="importProjectInput" accept=".json">
            </div>
        </div>
        <div class="tab" role="button" aria-label="Edit Menu">
            Edit
            <div class="dropdown-content">
                <button onclick="renumberQueue()">Renumber Queue</button>
                <button onclick="deleteCurrentTrack()">Delete Current Track</button>
                <button onclick="goBackOneStep()">Go Back One Step</button>
            </div>
        </div>
        <button class="go-button" onclick="playNextTrackSimultaneously()" aria-label="Play next track">Go</button>
    </div>

    <div class="left-panel">
        <table class="queue-table" id="queueList">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Track Name</th>
                    <th>Play/Pause</th>
                    <th>Notes</th>
                    <th>Progress</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Rows will be populated dynamically -->
            </tbody>
        </table>
        
        <div id="waveform"></div>
    </div>

    <script>
        let tracks = [];
        let wavesurfer = null;
        let currentIndex = -1;
        let nextIndex = -1;
        let interval = null;
        let history = [];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            // Load any saved data from localStorage
            const savedData = localStorage.getItem('soundQueueData');
            if (savedData) {
                try {
                    tracks = JSON.parse(savedData);
                    updateQueueList();
                } catch (e) {
                    console.error("Error loading saved data:", e);
                }
            }
        });

        // Save the current state
        function saveState() {
            history.push(JSON.stringify(tracks));
            if (history.length > 10) {
                history.shift();
            }
            localStorage.setItem('soundQueueData', JSON.stringify(tracks));
        }

        // Handle file input changes
        document.getElementById('fileInput').addEventListener('change', async (event) => {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;
            
            saveState();
            
            for (const file of files) {
                if (!file.type.startsWith('audio/')) {
                    alert(`File ${file.name} is not an audio file. Skipping.`);
                    continue;
                }
                
                const track = {
                    id: tracks.length,
                    name: file.name.replace(/\.[^/.]+$/, ""), // Remove file extension
                    file: file,
                    notes: '',
                    duration: 0,
                    progress: 0,
                    timeLeft: '0:00',
                    fileData: null // Will store the audio data
                };
                
                // Read the file data
                const reader = new FileReader();
                reader.onload = function(e) {
                    track.fileData = e.target.result;
                    tracks.push(track);
                    updateQueueList();
                    saveState();
                };
                reader.readAsDataURL(file);
            }
        });

        // Handle project import
        document.getElementById('importProjectInput').addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            saveState();
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const content = e.target.result;
                    const importedTracks = JSON.parse(content);
                    
                    // Convert base64 strings back to File objects
                    for (const track of importedTracks) {
                        if (track.fileData) {
                            const res = await fetch(track.fileData);
                            const blob = await res.blob();
                            track.file = new File([blob], track.name, { type: blob.type });
                        }
                    }
                    
                    tracks = importedTracks;
                    updateQueueList();
                    saveState();
                } catch (error) {
                    console.error("Error loading project:", error);
                    alert("Error loading project file. Please check the file format.");
                }
            };
            reader.readAsText(file);
        });

        // Export project as a JSON file
        function exportProject() {
            saveState();
            const projectData = JSON.stringify(tracks, null, 2);
            const dataBlob = new Blob([projectData], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sound_queue_project.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Renumber the queue
        function renumberQueue() {
            saveState();
            tracks.forEach((track, index) => {
                track.id = index;
            });
            updateQueueList();
        }

        // Delete current track
        function deleteCurrentTrack() {
            if (currentIndex >= 0 && currentIndex < tracks.length) {
                saveState();
                tracks.splice(currentIndex, 1);
                if (currentIndex >= tracks.length) {
                    currentIndex = tracks.length - 1;
                }
                updateQueueList();
                
                if (tracks.length > 0 && wavesurfer) {
                    playTrack(currentIndex);
                } else if (wavesurfer) {
                    wavesurfer.destroy();
                    wavesurfer = null;
                }
            }
        }

        // Go back one step in history
        function goBackOneStep() {
            if (history.length > 0) {
                const previousState = history.pop();
                try {
                    tracks = JSON.parse(previousState);
                    updateQueueList();
                    
                    if (currentIndex >= 0 && currentIndex < tracks.length && wavesurfer) {
                        playTrack(currentIndex);
                    } else if (wavesurfer) {
                        wavesurfer.destroy();
                        wavesurfer = null;
                    }
                } catch (e) {
                    console.error("Error restoring state:", e);
                }
            }
        }

        // Update the queue list UI
        function updateQueueList() {
            const queueList = document.querySelector('#queueList tbody');
            queueList.innerHTML = '';
            tracks.forEach((track, index) => {
                const row = document.createElement('tr');
                row.className = index === currentIndex ? 'queue-item active' : 
                                index === nextIndex ? 'queue-item next-track' : 'queue-item';
                
                row.innerHTML = `
                    <td>
                        <span class="track-number" onclick="editTrackNumber(${index})">${index + 1}</span>
                    </td>
                    <td>${track.name}</td>
                    <td>
                        <button class="play-pause-button" onclick="toggleTrack(${index})" aria-label="Play/Pause track">
                            <i class="fas ${wavesurfer && currentIndex === index && wavesurfer.isPlaying() ? 'fa-pause' : 'fa-play'}"></i>
                        </button>
                    </td>
                    <td>
                        <input type="text" class="notes-input" placeholder="Add notes..." 
                               onchange="updateNotes(${index}, this.value)" value="${track.notes}" 
                               aria-label="Track notes">
                    </td>
                    <td>
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-bar-fill" style="width: ${track.progress}%"></div>
                            </div>
                            <span class="time-left">${track.timeLeft}</span>
                        </div>
                    </td>
                    <td>
                        <button class="action-button" onclick="deleteTrack(${index})" title="Delete track">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                queueList.appendChild(row);
            });
        }

        // Delete a specific track
        function deleteTrack(index) {
            if (index >= 0 && index < tracks.length) {
                saveState();
                tracks.splice(index, 1);
                
                if (currentIndex === index) {
                    // If we're deleting the currently playing track
                    if (wavesurfer) {
                        wavesurfer.destroy();
                        wavesurfer = null;
                    }
                    currentIndex = -1;
                } else if (currentIndex > index) {
                    currentIndex--;
                }
                
                updateQueueList();
            }
        }

        // Edit track number
        function editTrackNumber(index) {
            const cell = document.querySelector(`#queueList tbody tr:nth-child(${index + 1}) td:first-child`);
            if (!cell) return;
            
            const currentNumber = index + 1;
            cell.innerHTML = `
                <input type="number" class="track-number-input" value="${currentNumber}" 
                       min="1" max="${tracks.length}" 
                       onblur="saveTrackNumber(${index}, this.value)"
                       onkeydown="handleTrackNumberKey(event, ${index}, this)">
            `;
            
            const input = cell.querySelector('input');
            input.select();
            input.focus();
        }

        // Save track number after editing
        function saveTrackNumber(oldIndex, newNumber) {
            newNumber = parseInt(newNumber);
            if (isNaN(newNumber)) {
                updateQueueList();
                return;
            }
            
            newNumber = Math.max(1, Math.min(tracks.length, newNumber)) - 1;
            if (newNumber === oldIndex) {
                updateQueueList();
                return;
            }
            
            saveState();
            
            const trackToMove = tracks.splice(oldIndex, 1)[0];
            tracks.splice(newNumber, 0, trackToMove);
            
            if (currentIndex === oldIndex) {
                currentIndex = newNumber;
            } else if (currentIndex > oldIndex && currentIndex <= newNumber) {
                currentIndex--;
            } else if (currentIndex < oldIndex && currentIndex >= newNumber) {
                currentIndex++;
            }
            
            if (nextIndex === oldIndex) {
                nextIndex = newNumber;
            } else if (nextIndex > oldIndex && nextIndex <= newNumber) {
                nextIndex--;
            } else if (nextIndex < oldIndex && nextIndex >= newNumber) {
                nextIndex++;
            }
            
            updateQueueList();
            
            // If we moved the currently playing track, restart it
            if (currentIndex === newNumber && wavesurfer) {
                playTrack(currentIndex);
            }
        }

        // Handle keyboard events for track number editing
        function handleTrackNumberKey(event, index, input) {
            if (event.key === 'Enter') {
                event.preventDefault();
                input.blur();
            }
        }

        // Update track notes
        function updateNotes(index, value) {
            tracks[index].notes = value;
            saveState();
        }

        // Toggle play/pause for a track
        function toggleTrack(index) {
            if (currentIndex === index && wavesurfer) {
                if (wavesurfer.isPlaying()) {
                    wavesurfer.pause();
                } else {
                    wavesurfer.play();
                }
            } else {
                playTrack(index);
            }
            updateQueueList();
        }

        // Play the next track simultaneously
        function playNextTrackSimultaneously() {
            if (currentIndex + 1 < tracks.length) {
                nextIndex = currentIndex + 1;
                updateQueueList();
            } else {
                alert("No more tracks in the queue.");
            }
        }

        // Play a specific track
        function playTrack(index) {
            if (index < 0 || index >= tracks.length) return;
            
            if (wavesurfer) {
                wavesurfer.destroy();
                clearInterval(interval);
            }

            currentIndex = index;
            nextIndex = -1;
            updateQueueList();

            const track = tracks[index];
            let audioSrc;
            
            if (track.fileData) {
                audioSrc = track.fileData;
            } else if (track.file) {
                audioSrc = URL.createObjectURL(track.file);
            } else {
                console.error("No audio source available for track:", track);
                return;
            }

            wavesurfer = WaveSurfer.create({
                container: '#waveform',
                waveColor: '#555',
                progressColor: '#FFD700',
                cursorColor: '#FFD700',
                barWidth: 2,
                barRadius: 3,
                height: 80,
                responsive: true
            });

            wavesurfer.load(audioSrc);

            wavesurfer.on('ready', () => {
                track.duration = wavesurfer.getDuration();
                wavesurfer.play();
                updateQueueList();
                startProgressUpdate();
            });

            wavesurfer.on('finish', () => {
                stopProgressUpdate();
                if (nextIndex >= 0) {
                    playTrack(nextIndex);
                } else if (currentIndex + 1 < tracks.length) {
                    playTrack(currentIndex + 1);
                }
            });

            wavesurfer.on('error', (error) => {
                console.error("Error loading track:", error);
                alert("Error loading track. Please check the file format.");
            });
        }

        // Start updating progress
        function startProgressUpdate() {
            stopProgressUpdate();
            interval = setInterval(() => {
                if (wavesurfer && currentIndex >= 0) {
                    const currentTime = wavesurfer.getCurrentTime();
                    const duration = wavesurfer.getDuration();
                    const progress = (currentTime / duration) * 100;
                    tracks[currentIndex].progress = progress;
                    
                    const timeLeft = duration - currentTime;
                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = Math.floor(timeLeft % 60);
                    tracks[currentIndex].timeLeft = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                    
                    const row = document.querySelector(`#queueList tbody tr:nth-child(${currentIndex + 1})`);
                    if (row) {
                        const progressBar = row.querySelector('.progress-bar-fill');
                        const timeLeftElement = row.querySelector('.time-left');
                        if (progressBar) progressBar.style.width = `${progress}%`;
                        if (timeLeftElement) timeLeftElement.textContent = tracks[currentIndex].timeLeft;
                    }
                }
            }, 100);
        }

        // Stop updating progress
        function stopProgressUpdate() {
            if (interval) {
                clearInterval(interval);
                interval = null;
            }
        }

        // Keyboard controls
        document.addEventListener('keydown', (event) => {
            if (event.target.tagName.toLowerCase() !== 'input' || event.target.classList.contains('track-number-input')) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    if (event.target.classList.contains('track-number-input')) {
                        event.target.blur();
                    } else {
                        playNextTrackSimultaneously();
                    }
                }
                
                if (event.key === ' ') {
                    event.preventDefault();
                    if (currentIndex >= 0) {
                        toggleTrack(currentIndex);
                    } else if (tracks.length > 0) {
                        playTrack(0);
                    }
                }
                
                if (event.key === 'Delete') {
                    if (currentIndex >= 0) {
                        deleteCurrentTrack();
                    }
                }
                
                if (event.key === 'Backspace') {
                    goBackOneStep();
                }
            }
        });
    </script>
</body>
</html>
