<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sound Queue Manager</title>
    <script src="https://unpkg.com/wavesurfer.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Add your CSS styles here */
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="tab" role="button" aria-label="Files Menu">
            Files
            <div class="dropdown-content">
                <label for="fileInput" style="cursor: pointer;">Import Music</label>
                <input type="file" id="fileInput" multiple aria-label="Upload audio files">
                <button onclick="exportProject()">Export Project</button>
                <label for="importProjectInput" style="cursor: pointer;">Load Project</label>
                <input type="file" id="importProjectInput" accept=".json">
            </div>
        </div>
        <div class="tab" role="button" aria-label="Edit Menu">
            Edit
            <div class="dropdown-content">
                <button onclick="reorderQueue()">Reorder Queue</button>
            </div>
        </div>
        <button class="go-button" onclick="playNextTrackSimultaneously()" aria-label="Play next track">Go</button>
    </div>

    <div class="left-panel">
        <table class="queue-table" id="queueList">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Track Name</th>
                    <th>Play/Pause</th>
                    <th>Notes</th>
                </tr>
            </thead>
            <tbody>
                <!-- Rows will be populated dynamically -->
            </tbody>
        </table>
    </div>

    <div id="waveformContainer">
        <div id="trackInfo">No track loaded</div>
        <div id="timeInfo">Duration: 00:00 | Time Left: 00:00</div>
        <div id="waveform"><div></div></div>
        <div id="waveformPlayPause">
            <button onclick="toggleWaveformPlayPause()">
                <i class="fas fa-play"></i>
            </button>
        </div>
    </div>

    <script>
        let tracks = [];
        let wavesurfer = null;
        let nextWavesurfer = null; // For simultaneous playback
        let currentIndex = -1;

        // Handle file input changes
        document.getElementById('fileInput').addEventListener('change', async (event) => {
            const files = Array.from(event.target.files);
            for (const file of files) {
                const track = {
                    id: tracks.length,
                    name: file.name,
                    file: file, // Store the file object directly
                    notes: ''
                };
                tracks.push(track);
            }
            updateQueueList(); // Update the queue list after importing files
        });

        // Handle project import
        document.getElementById('importProjectInput').addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const content = e.target.result;
                    tracks = JSON.parse(content);
                    updateQueueList(); // Update the queue list after loading the project
                };
                reader.readAsText(file);
            }
        });

        // Export project as a JSON file
        function exportProject() {
            const projectData = JSON.stringify(tracks, null, 2);
            const dataBlob = new Blob([projectData], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sound_queue_project.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Reorder the queue
        function reorderQueue() {
            const queueList = document.querySelector('#queueList tbody');
            const rows = Array.from(queueList.querySelectorAll('tr'));
            const newOrder = rows.map(row => {
                const index = parseInt(row.querySelector('td').innerText) - 1;
                return tracks[index];
            });
            tracks = newOrder;
            updateQueueList();
        }

        // Update the queue list UI
        function updateQueueList() {
            const queueList = document.querySelector('#queueList tbody');
            queueList.innerHTML = ''; // Clear the existing rows
            tracks.forEach((track, index) => {
                const row = document.createElement('tr');
                row.className = index === currentIndex ? 'queue-item active' : 'queue-item';
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${track.name}</td>
                    <td><button class="play-pause-button" onclick="toggleTrack(${index})" aria-label="Play/Pause track">
                            <i class="fas ${wavesurfer && currentIndex === index && wavesurfer.isPlaying() ? 'fa-pause' : 'fa-play'}"></i>
                        </button></td>
                    <td><input type="text" class="notes-input" placeholder="Add notes..." onchange="updateNotes(${index}, this.value)" value="${track.notes}" aria-label="Track notes"></td>
                `;
                queueList.appendChild(row);
            });
        }

        // Update track notes
        function updateNotes(index, value) {
            tracks[index].notes = value;
        }

        // Toggle play/pause for a track
        function toggleTrack(index) {
            if (wavesurfer && currentIndex === index) {
                wavesurfer.isPlaying() ? wavesurfer.pause() : wavesurfer.play();
                updateQueueList(); // Update the play/pause icon
            } else {
                playTrack(index);
            }
        }

        // Toggle play/pause for the waveform player
        function toggleWaveformPlayPause() {
            if (wavesurfer) {
                wavesurfer.isPlaying() ? wavesurfer.pause() : wavesurfer.play();
                updateWaveformPlayPauseIcon();
            }
        }

        // Update the waveform play/pause icon
        function updateWaveformPlayPauseIcon() {
            const playPauseButton = document.querySelector('#waveformPlayPause button i');
            if (wavesurfer && wavesurfer.isPlaying()) {
                playPauseButton.classList.remove('fa-play');
                playPauseButton.classList.add('fa-pause');
            } else {
                playPauseButton.classList.remove('fa-pause');
                playPauseButton.classList.add('fa-play');
            }
        }

        // Play the next track simultaneously
        function playNextTrackSimultaneously() {
            if (currentIndex + 1 < tracks.length) {
                if (wavesurfer && wavesurfer.isPlaying()) {
                    // Play the next track simultaneously
                    playTrack(currentIndex + 1, true);
                } else {
                    // If no track is playing, just play the next track
                    playTrack(currentIndex + 1);
                }
            } else {
                alert("No more tracks in the queue.");
            }
        }

        // Play a specific track
        function playTrack(index, simultaneous = false) {
            // Destroy the previous wavesurfer instance if it exists
            if (wavesurfer) {
                wavesurfer.destroy();
                wavesurfer = null;
            }

            // Destroy the nextWavesurfer instance if it exists
            if (nextWavesurfer) {
                nextWavesurfer.destroy();
                nextWavesurfer = null;
            }

            currentIndex = index;
            updateQueueList();

            const track = tracks[index];
            const audioSrc = URL.createObjectURL(track.file);

            if (simultaneous) {
                // Create a new WaveSurfer instance for simultaneous playback
                nextWavesurfer = WaveSurfer.create({
                    container: '#waveform',
                    waveColor: '#555',
                    progressColor: '#FFD700',
                    cursorColor: '#FFD700',
                    barWidth: 2,
                    barRadius: 3,
                    height: 80,
                    responsive: true
                });

                nextWavesurfer.load(audioSrc);
                nextWavesurfer.play();
            } else {
                wavesurfer = WaveSurfer.create({
                    container: '#waveform',
                    waveColor: '#555',
                    progressColor: '#FFD700',
                    cursorColor: '#FFD700',
                    barWidth: 2,
                    barRadius: 3,
                    height: 80,
                    responsive: true
                });

                wavesurfer.load(audioSrc);
                document.getElementById('trackInfo').innerText = track.name;

                wavesurfer.on('ready', () => {
                    updateTimeInfo(wavesurfer.getDuration(), 0);
                    wavesurfer.play();
                    updateWaveformPlayPauseIcon();
                });

                wavesurfer.on('finish', () => {
                    updateWaveformPlayPauseIcon();
                });

                wavesurfer.on('error', (error) => {
                    console.error("Error loading track:", error);
                    alert("Error loading track. Please check the file format.");
                });
            }
        }

        // Update time information
        function updateTimeInfo(duration, currentTime) {
            const remainingTime = Math.max(0, duration - currentTime);
            const formatTime = (time) => new Date(time * 1000).toISOString().substring(14, 19);
            document.getElementById('timeInfo').innerText = `Duration: ${formatTime(duration)} | Time Left: ${formatTime(remainingTime)}`;
        }

        // Bind Enter key to the "Go" button
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                playNextTrackSimultaneously();
            }
        });

        // Bind Spacebar to play/pause
        document.addEventListener('keydown', (event) => {
            if (event.key === ' ') { // Spacebar key
                event.preventDefault(); // Prevent default spacebar behavior (scrolling)
                toggleWaveformPlayPause();
            }
        });
    </script>
</body>
</html>
